<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Join Classroom Poll</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f7f5f2;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 32px;
      max-width: 400px;
      width: 100%;
    }

    h1 {
      color: #1f2937;
      margin-bottom: 24px;
      text-align: center;
      font-size: 28px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      color: #4b5563;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #10b981;
    }

    .code-input {
      text-align: center;
      font-size: 24px;
      letter-spacing: 8px;
      font-weight: 600;
    }

    button {
      width: 100%;
      padding: 14px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #059669;
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .error {
      color: #ef4444;
      font-size: 14px;
      margin-top: 8px;
      text-align: center;
    }

    .poll-container {
      display: none;
    }

    .poll-question {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 24px;
    }

    .poll-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .poll-option {
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .poll-option:hover {
      border-color: #10b981;
      background: #f0fdf4;
    }

    .poll-option.selected {
      border-color: #10b981;
      background: #10b981;
      color: white;
    }

    .poll-option.voted {
      cursor: default;
    }

    .vote-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: rgba(16, 185, 129, 0.2);
      transition: width 0.3s ease;
    }

    .vote-content {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .waiting {
      text-align: center;
      color: #6b7280;
      font-size: 16px;
    }

    .status {
      text-align: center;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .status.active {
      background: #d1fae5;
      color: #065f46;
    }

    .status.inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    .thank-you {
      text-align: center;
      color: #10b981;
      font-size: 18px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="joinForm">
      <h1>Join Poll</h1>
      <form id="codeForm">
        <div class="form-group">
          <label for="code">Enter Room Code</label>
          <input 
            type="text" 
            id="code" 
            class="code-input"
            maxlength="4"
            pattern="[0-9]{4}"
            placeholder="0000"
            required
          >
        </div>
        <div class="form-group">
          <label for="name">Your Name (Optional)</label>
          <input 
            type="text" 
            id="name"
            placeholder="Student"
          >
        </div>
        <button type="submit">Join Poll</button>
        <div id="error" class="error"></div>
      </form>
    </div>

    <div id="pollContainer" class="poll-container">
      <div id="pollStatus" class="status"></div>
      <div id="pollContent"></div>
    </div>
  </div>

  <script>
    const socket = io();
    let roomCode = '';
    let hasVoted = false;
    let currentPollData = {};

    const joinForm = document.getElementById('joinForm');
    const pollContainer = document.getElementById('pollContainer');
    const codeForm = document.getElementById('codeForm');
    const errorDiv = document.getElementById('error');
    const pollContent = document.getElementById('pollContent');
    const pollStatus = document.getElementById('pollStatus');

    // Handle form submission
    codeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.textContent = '';
      
      const code = document.getElementById('code').value;
      const name = document.getElementById('name').value;

      // Check if room exists
      try {
        const response = await fetch(`/api/rooms/${code}/exists`);
        const data = await response.json();
        
        if (data.exists) {
          roomCode = code;
          socket.emit('participant:join', { code, name });
        } else {
          errorDiv.textContent = 'Invalid room code';
        }
      } catch (err) {
        errorDiv.textContent = 'Connection error';
      }
    });

    // Format code input
    document.getElementById('code').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });

    // Socket event handlers
    socket.on('participant:joined', (data) => {
      if (data.success) {
        joinForm.style.display = 'none';
        pollContainer.style.display = 'block';
        currentPollData = data.pollData || {};
        updatePollDisplay(currentPollData);
      } else {
        errorDiv.textContent = data.error || 'Failed to join';
      }
    });

    socket.on('poll:updated', (pollData) => {
      // Merge the update with existing data
      currentPollData = { ...currentPollData, ...pollData };
      updatePollDisplay(currentPollData);
    });

    socket.on('poll:status', (data) => {
      // This event is now deprecated but kept for compatibility
      currentPollData.isActive = data.isActive;
      updatePollDisplay(currentPollData);
    });

    socket.on('results:update', (results) => {
      updateResults(results);
    });

    socket.on('vote:confirmed', (data) => {
      if (data.success) {
        hasVoted = true;
        showThankYou();
      }
    });

    function updatePollDisplay(pollData) {
      // Update status
      pollStatus.textContent = pollData.isActive ? 'Poll Active' : 'Poll Closed';
      pollStatus.className = `status ${pollData.isActive ? 'active' : 'inactive'}`;

      if (!pollData.question || !pollData.options || pollData.options.length === 0) {
        pollContent.innerHTML = '<div class="waiting">Waiting for poll to start...</div>';
        return;
      }

      if (hasVoted) {
        showThankYou();
        return;
      }

      let html = `<div class="poll-question">${pollData.question}</div>`;
      html += '<div class="poll-options">';
      
      pollData.options.forEach((option, index) => {
        html += `
          <div class="poll-option" data-index="${index}">
            <div class="vote-content">${option}</div>
          </div>
        `;
      });
      
      html += '</div>';
      pollContent.innerHTML = html;

      // Add click handlers
      if (pollData.isActive && !hasVoted) {
        document.querySelectorAll('.poll-option').forEach(option => {
          option.addEventListener('click', () => {
            const index = parseInt(option.dataset.index);
            submitVote(index);
          });
        });
      }
    }

    function submitVote(optionIndex) {
      if (hasVoted) return;
      
      // Visual feedback
      document.querySelectorAll('.poll-option').forEach(option => {
        option.classList.remove('selected');
      });
      document.querySelector(`[data-index="${optionIndex}"]`).classList.add('selected');
      
      // Submit vote
      socket.emit('vote:submit', { code: roomCode, optionIndex });
    }

    function updateResults(results) {
      if (!hasVoted) return;

      const totalVotes = results.totalVotes || 1;
      
      document.querySelectorAll('.poll-option').forEach((option, index) => {
        const votes = results.votes[index] || 0;
        const percentage = (votes / totalVotes * 100).toFixed(0);
        
        option.classList.add('voted');
        option.innerHTML = `
          <div class="vote-bar" style="width: ${percentage}%"></div>
          <div class="vote-content">
            <span>${results.options[index]}</span>
            <span>${votes} (${percentage}%)</span>
          </div>
        `;
      });
    }

    function showThankYou() {
      pollContent.innerHTML = '<div class="thank-you">Thank you for voting!</div>';
    }
  </script>
</body>
</html>