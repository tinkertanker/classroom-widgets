version: '3.8'

# ============================================
# Production Docker Compose
# ============================================
# Usage: docker-compose -f docker-compose.prod.yml up -d
# Requires: .env.production file with real secrets
#
# For nginx-proxy setup, this uses:
# - VIRTUAL_HOST for domain routing
# - LETSENCRYPT_HOST for SSL certificates

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.prod
      args:
        # Build-time variables (baked into the image)
        - VITE_SERVER_URL=${VITE_SERVER_URL}
        - VITE_SHORTIO_API_KEY=${VITE_SHORTIO_API_KEY}
        - VITE_SHORTIO_BASE_URL=${VITE_SHORTIO_BASE_URL}
        - VITE_UMAMI_SCRIPT_URL=${VITE_UMAMI_SCRIPT_URL}
        - VITE_UMAMI_WEBSITE_ID=${VITE_UMAMI_WEBSITE_ID}
    image: classroom-widgets-frontend:latest
    container_name: classroom-widgets-frontend
    expose:
      - 80
    environment:
      # nginx-proxy configuration
      - VIRTUAL_PORT=80
      - VIRTUAL_HOST=${FRONTEND_DOMAIN}
      - LETSENCRYPT_HOST=${FRONTEND_DOMAIN}
      - LETSENCRYPT_EMAIL=${FRONTEND_EMAIL}
    networks:
      - devtksg
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    build:
      context: .
      dockerfile: ./server/Dockerfile.prod
    container_name: classroom-widgets-backend
    image: classroom-widgets-backend:latest
    expose:
      - 3001
    environment:
      # Application configuration
      - NODE_ENV=production
      - PORT=3001
      - CORS_ORIGINS=${CORS_ORIGINS}
      # nginx-proxy configuration
      - VIRTUAL_PORT=3001
      - VIRTUAL_HOST=${BACKEND_DOMAIN}
      - LETSENCRYPT_HOST=${BACKEND_DOMAIN}
      - LETSENCRYPT_EMAIL=${BACKEND_EMAIL}
    networks:
      - devtksg
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Umami Analytics (Privacy-focused)
  # ============================================
  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    container_name: classroom-widgets-umami
    expose:
      - 3000
    environment:
      - DATABASE_URL=postgresql://${UMAMI_DB_USER:-umami}:${UMAMI_DB_PASSWORD}@umami-db:5432/umami
      - DATABASE_TYPE=postgresql
      - APP_SECRET=${UMAMI_APP_SECRET}
      # nginx-proxy configuration
      - VIRTUAL_PORT=3000
      - VIRTUAL_HOST=${UMAMI_DOMAIN}
      - LETSENCRYPT_HOST=${UMAMI_DOMAIN}
      - LETSENCRYPT_EMAIL=${UMAMI_EMAIL}
    depends_on:
      umami-db:
        condition: service_healthy
    networks:
      - devtksg
    restart: unless-stopped

  umami-db:
    image: postgres:15-alpine
    container_name: classroom-widgets-umami-db
    environment:
      - POSTGRES_DB=umami
      - POSTGRES_USER=${UMAMI_DB_USER:-umami}
      - POSTGRES_PASSWORD=${UMAMI_DB_PASSWORD}
    volumes:
      - umami-db-data:/var/lib/postgresql/data
    networks:
      - devtksg
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${UMAMI_DB_USER:-umami}"]
      interval: 5s
      timeout: 5s
      retries: 5

networks:
  devtksg:
    external: true

volumes:
  umami-db-data:
