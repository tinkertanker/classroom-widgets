version: '3'

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.prod
      args:
        - VITE_SERVER_URL=https://go.tk.sg
    image: classroom-widgets-frontend:latest
    expose:
      - 80
    environment:
      VIRTUAL_PORT: 80
      VIRTUAL_HOST: widgets.tk.sg
      LETSENCRYPT_HOST: widgets.tk.sg
      LETSENCRYPT_EMAIL: "sysops@m.tinkertanker.com"
    networks:
      - devtksg
    restart: always

  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    image: classroom-widgets-backend:latest
    expose:
      - 3001
    environment:
      - NODE_ENV=production
      - PORT=3001
      - CORS_ORIGINS=https://widgets.tk.sg,http://widgets.tk.sg,https://go.tk.sg
      - VIRTUAL_PORT=3001
      - VIRTUAL_HOST=go.tk.sg
      - LETSENCRYPT_HOST=go.tk.sg
      - LETSENCRYPT_EMAIL=sysops@m.tinkertanker.com
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - devtksg
    restart: always

networks:
  devtksg:
    external: true